{% extends 'base.html' %}
{% load static %}

{% block title %}Company Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card my-4">
                <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                    <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                        <h6 class="text-white text-capitalize ps-3">Company Management</h6>
                    </div>
                </div>
                <div class="card-body px-0 pb-2">
                    <!-- Search and Filter Section -->
                    <div class="row px-3 mb-3">
                        <div class="col-md-8">
                            <form method="get" class="d-flex">
                                <div class="input-group">
                                    <span class="input-group-text text-body">
                                        <i class="fas fa-search" aria-hidden="true"></i>
                                    </span>
                                    <input type="text" class="form-control" name="search" 
                                           value="{{ search_form.search.value|default:'' }}" 
                                           placeholder="Search companies...">
                                </div>
                                <select name="status" class="form-select ms-2" style="width: auto;">
                                    <option value="">All Statuses</option>
                                    {% for value, label in search_form.status.field.choices %}
                                        {% if value %}
                                            <option value="{{ value }}" {% if search_form.status.value == value %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn btn-primary ms-2">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </form>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createCompanyModal">
                                <i class="fas fa-plus"></i> Create Company
                            </button>
                            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#assignUserModal">
                                <i class="fas fa-user-plus"></i> Assign User
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="row px-3 mb-3">
                        <div class="col-md-3">
                            <div class="card bg-gradient-info">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="flex-grow-1">
                                            <h6 class="text-white">Total Companies</h6>
                                            <h3 class="text-white">{{ total_companies }}</h3>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-building text-white opacity-10" style="font-size: 2rem;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-gradient-success">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="flex-grow-1">
                                            <h6 class="text-white">Active Companies</h6>
                                            <h3 class="text-white">{{ active_companies }}</h3>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-check-circle text-white opacity-10" style="font-size: 2rem;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-gradient-warning">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="flex-grow-1">
                                            <h6 class="text-white">Pending</h6>
                                            <h3 class="text-white">{{ companies|length }}</h3>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-clock text-white opacity-10" style="font-size: 2rem;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-gradient-danger">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="flex-grow-1">
                                            <h6 class="text-white">Suspended</h6>
                                            <h3 class="text-white">0</h3>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-ban text-white opacity-10" style="font-size: 2rem;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Companies Table -->
                    <div class="table-responsive p-0">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Company</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Contact</th>
                                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Users</th>
                                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Created</th>
                                    <th class="text-secondary opacity-7">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in companies %}
                                <tr>
                                    <td>
                                        <div class="d-flex px-2 py-1">
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm">{{ company.name }}</h6>
                                                <p class="text-xs text-secondary mb-0">{{ company.industry|default:"No industry specified" }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <p class="text-xs font-weight-bold mb-0">{{ company.email }}</p>
                                        <p class="text-xs text-secondary mb-0">{{ company.phone }}</p>
                                    </td>
                                    <td class="align-middle text-center text-sm">
                                        {% if company.status == 'active' %}
                                            <span class="badge badge-sm bg-gradient-success">{{ company.get_status_display }}</span>
                                        {% elif company.status == 'pending' %}
                                            <span class="badge badge-sm bg-gradient-warning">{{ company.get_status_display }}</span>
                                        {% elif company.status == 'suspended' %}
                                            <span class="badge badge-sm bg-gradient-danger">{{ company.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge badge-sm bg-gradient-secondary">{{ company.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="align-middle text-center">
                                        <span class="text-secondary text-xs font-weight-bold">{{ company.company_users.count }}</span>
                                    </td>
                                    <td class="align-middle text-center">
                                        <span class="text-secondary text-xs font-weight-bold">{{ company.created_at|date:"M d, Y" }}</span>
                                    </td>
                                    <td class="align-middle">
                                        <a href="{% url 'company_management:company_detail' company.pk %}" 
                                           class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" 
                                           data-original-title="View details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'company_management:company_edit' company.pk %}" 
                                           class="text-secondary font-weight-bold text-xs ms-2" data-toggle="tooltip" 
                                           data-original-title="Edit company">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <p class="text-muted">No companies found.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if companies.has_other_pages %}
                    <div class="d-flex justify-content-center mt-3">
                        <nav aria-label="Page navigation">
                            <ul class="pagination">
                                {% if companies.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ companies.previous_page_number }}">Previous</a>
                                    </li>
                                {% endif %}
                                
                                {% for num in companies.paginator.page_range %}
                                    {% if companies.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > companies.number|add:'-3' and num < companies.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if companies.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ companies.next_page_number }}">Next</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Company Modal -->
<div class="modal fade" id="createCompanyModal" tabindex="-1" aria-labelledby="createCompanyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createCompanyModalLabel">Create New Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createCompanyForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="company_name" class="form-label">Company Name *</label>
                                <input type="text" class="form-control" id="company_name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="company_email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="company_email" name="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="company_phone" class="form-label">Phone *</label>
                                <input type="text" class="form-control" id="company_phone" name="phone" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="company_website" class="form-label">Website</label>
                                <input type="url" class="form-control" id="company_website" name="website">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="company_address" class="form-label">Address *</label>
                        <textarea class="form-control" id="company_address" name="address" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="company_registration" class="form-label">Registration Number</label>
                                <input type="text" class="form-control" id="company_registration" name="registration_number">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="company_tax_id" class="form-label">Tax ID</label>
                                <input type="text" class="form-control" id="company_tax_id" name="tax_id">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="company_industry" class="form-label">Industry</label>
                                <input type="text" class="form-control" id="company_industry" name="industry">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="company_status" class="form-label">Status</label>
                        <select class="form-control" id="company_status" name="status">
                            <option value="pending">Pending</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Company</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign User Modal -->
<div class="modal fade" id="assignUserModal" tabindex="-1" aria-labelledby="assignUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignUserModalLabel">Assign User to Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="assignUserForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="user_select" class="form-label">User *</label>
                        <select class="form-control" id="user_select" name="user" required>
                            <option value="">Select a user...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="company_select" class="form-label">Company *</label>
                        <select class="form-control" id="company_select" name="company" required>
                            <option value="">Select a company...</option>
                            {% for company in companies %}
                                <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="role_select" class="form-label">Role *</label>
                        <select class="form-control" id="role_select" name="role" required>
                            <option value="">Select a role...</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_primary" name="is_primary">
                        <label class="form-check-label" for="is_primary">
                            Primary Contact
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load roles when page loads
    loadRoles();
    
    // Load users when company changes
    document.getElementById('company_select').addEventListener('change', function() {
        const companyId = this.value;
        if (companyId) {
            loadUsers(companyId);
        } else {
            document.getElementById('user_select').innerHTML = '<option value="">Select a user...</option>';
        }
    });
    
    // Create company form submission
    document.getElementById('createCompanyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createCompany();
    });
    
    // Assign user form submission
    document.getElementById('assignUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        assignUser();
    });
});

function loadRoles() {
    fetch('{% url "company_management:ajax_get_roles" %}')
        .then(response => response.json())
        .then(data => {
            const roleSelect = document.getElementById('role_select');
            roleSelect.innerHTML = '<option value="">Select a role...</option>';
            data.roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                roleSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading roles:', error));
}

function loadUsers(companyId) {
    fetch(`{% url "company_management:ajax_get_users" %}?company_id=${companyId}`)
        .then(response => response.json())
        .then(data => {
            const userSelect = document.getElementById('user_select');
            userSelect.innerHTML = '<option value="">Select a user...</option>';
            data.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.first_name} ${user.last_name} (${user.email})`;
                userSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading users:', error));
}

function createCompany() {
    const form = document.getElementById('createCompanyForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('{% url "company_management:ajax_company_create" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showAlert('success', data.message);
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('createCompanyModal')).hide();
            // Reload page to show new company
            location.reload();
        } else {
            // Show error messages
            showAlert('error', 'Please fix the errors below:');
            console.error('Validation errors:', data.errors);
        }
    })
    .catch(error => {
        console.error('Error creating company:', error);
        showAlert('error', 'An error occurred while creating the company.');
    });
}

function assignUser() {
    const form = document.getElementById('assignUserForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('{% url "company_management:ajax_company_user_assign" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showAlert('success', data.message);
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('assignUserModal')).hide();
            // Reset form
            form.reset();
        } else {
            // Show error messages
            showAlert('error', 'Please fix the errors below:');
            console.error('Validation errors:', data.errors);
        }
    })
    .catch(error => {
        console.error('Error assigning user:', error);
        showAlert('error', 'An error occurred while assigning the user.');
    });
}

function showAlert(type, message) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Insert at the top of the content
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
