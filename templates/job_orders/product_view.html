{% extends 'base.html' %}
{% block title %}Product View - {{ product.job_order }}{% endblock %}

{% block content %}
<style>
.priority-badge.priority-0 { background-color: #6c757d !important; } /* Low - Gray */
.priority-badge.priority-1 { background-color: #17a2b8 !important; } /* Normal - Info Blue */
.priority-badge.priority-2 { background-color: #ffc107 !important; color: #212529 !important; } /* High - Warning Yellow */
.priority-badge.priority-3 { background-color: #dc3545 !important; } /* Urgent - Danger Red */

.user-info .badge {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    line-height: 1.3;
    text-align: left;
    white-space: normal;
    word-wrap: break-word;
}

.user-info .badge i {
    margin-right: 0.25rem;
}

.user-info .badge small {
    font-size: 0.65rem;
    opacity: 0.9;
    display: block;
    margin-top: 0.25rem;
}

.user-info .badge small i {
    margin-right: 0.15rem;
    color: #6c757d;
}

.timeline-item .user-info {
    margin-top: 0.5rem;
}

#current-production-status .badge {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    line-height: 1.3;
    text-align: left;
    white-space: normal;
    word-wrap: break-word;
}

#current-production-status .badge small {
    font-size: 0.65rem;
    opacity: 0.9;
    display: block;
    margin-top: 0.25rem;
}

#current-production-status .badge small i {
    margin-right: 0.15rem;
    color: #6c757d;
}
</style>
{% include 'partials/topside.html' %}

<div class="row my-4">
    <div class="col-md-10 mx-auto">
        <div class="card card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Job Order: {{ product.job_order }}</h5>
                <div>
                    <a href="{% url 'job_orders:export_single_product_pdf' product.job_order %}" class="btn btn-primary">
                        <i class="fas fa-download"></i> Export PDF
                    </a>
                    <a href="{% url 'job_orders:products' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
            <hr>
            
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary">Basic Information</h6>
                    <table class="table table-borderless">
                        <tr><td><strong>Job Order:</strong></td><td>{{ product.job_order }}</td></tr>
                        <tr><td><strong>Submission ID:</strong></td><td>{{ product.submission_id }}</td></tr>
                        <tr><td><strong>Organization:</strong></td><td>{{ product.organization_name }}</td></tr>
                        <tr><td><strong>Category:</strong></td><td>{{ product.category }}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="text-primary">Customer Information</h6>
                    <table class="table table-borderless">
                        <tr><td><strong>Address:</strong></td><td>{{ product.address }}</td></tr>
                        <tr><td><strong>Contact:</strong></td><td>{{ product.contact_number }}</td></tr>
                        <tr><td><strong>Created By:</strong></td><td>{{ product.created_by.email }}</td></tr>
                        <tr><td><strong>Created Date:</strong></td><td>{{ product.date_created|date:"Y-m-d H:i:s" }}</td></tr>
                        <tr><td><strong>Status:</strong></td><td><span class="badge bg-{{ product.approval_status == 'approved' and 'success' or product.approval_status == 'rejected' and 'danger' or 'warning' }}" data-approval-status>{{ product.get_approval_status_display }}</span></td></tr>
                    </table>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <h6 class="text-primary">Product Specifications</h6>
                    <table class="table table-borderless">
                        <tr><td><strong>Package Type:</strong></td><td>{{ product.print_product }}</td></tr>
                        <tr><td><strong>Size:</strong></td><td>{{ product.size }}</td></tr>
                        <tr><td><strong>Colors:</strong></td><td>{{ product.colors }}</td></tr>
                        <tr><td><strong>Treatment:</strong></td><td>{{ product.treatment }}</td></tr>
                        <tr><td><strong>Cutting Length:</strong></td><td>{{ product.cutting_length }}</td></tr>
                        <tr><td><strong>Flap:</strong></td><td>{{ product.flap }}</td></tr>
                        <tr><td><strong>Micron:</strong></td><td>{{ product.micron }}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="text-primary">Pricing & Delivery</h6>
                    <table class="table table-borderless">
                        <tr><td><strong>Price:</strong></td><td>{{ product.formatted_price }}</td></tr>
                        <tr><td><strong>Extrusion Qty:</strong></td><td>{{ product.job_title }}</td></tr>
                        <tr><td><strong>Delivery Qty:</strong></td><td>{{ product.order_quantity }}</td></tr>
                        <tr><td><strong>Total:</strong></td><td>{{ product.formatted_total }}</td></tr>
                        <tr><td><strong>Est. Delivery:</strong></td><td>{{ product.estimated_delivery_date|date:"Y-m-d"|default:"Not set" }}</td></tr>
                        <tr><td><strong>Cycle Time:</strong></td><td>{{ product.cycle_time|default:"Not calculated" }}</td></tr>
                    </table>
                </div>
            </div>
            
            {% if product.order_info %}
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-primary">Order Information</h6>
                    <div class="border p-3 bg-light">
                        {{ product.order_info }}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if product.production_status %}
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-primary">Current Production Status</h6>
                    <div class="border p-3 bg-info text-white" id="current-production-status">
                        <div id="current-status-text">{{ product.production_status }}</div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small id="current-status-meta">
                                Last updated: {{ product.production_status_date|date:"Y-m-d H:i:s" }}
                            </small>
                            {% if product.updated_by %}
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-user"></i> {{ product.updated_by.get_full_name }}
                                {% if product.updated_by.phone and product.updated_by.phone.strip %}
                                    <br><small><i class="fas fa-phone"></i> {{ product.updated_by.phone }}</small>
                                {% else %}
                                    <br><small><i class="fas fa-phone-slash text-muted"></i> No phone</small>
                                {% endif %}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Status Update Form -->
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-primary">Add Status Update</h6>
                    <div class="card">
                        <div class="card-body">
                            <form id="statusUpdateForm" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                <div class="mb-3">
                                    <label for="new_status" class="form-label">Status Update</label>
                                    <textarea class="form-control" id="new_status" name="new_status" rows="4" 
                                              placeholder="Enter your status update or progress report..." required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="priority" class="form-label">Priority Level</label>
                                    <select class="form-control" id="priority" name="priority">
                                        <option value="0">Low</option>
                                        <option value="1" selected>Normal</option>
                                        <option value="2">High</option>
                                        <option value="3">Urgent</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add Status Update
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if status_history %}
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-primary">Status Update History</h6>
                    
                    <!-- Debug Information -->
                    <div class="alert alert-info">
                        <strong>Debug Info:</strong><br>
                        Current User: {{ user.get_full_name }} ({{ user.email }})<br>
                        Phone: "{{ user.phone|default:"No phone number" }}" (Length: {{ user.phone|length|default:0 }})<br>
                        Status History Count: {{ status_history|length }}<br>
                        Phone Logic: {% if user.phone and user.phone.strip %}Has phone{% else %}No phone{% endif %}
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="timeline">
                                {% for status in status_history %}
                                <div class="timeline-item mb-3" id="status-{{ status.id }}">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="fas fa-info-circle"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <h6 class="card-title mb-0">
                                                            Status Update #{{ forloop.revcounter }}
                                                            <span class="badge ms-2 priority-badge priority-{{ status.priority }}" id="priority-badge-{{ status.id }}">Priority: {{ status.get_priority_display }}</span>
                                                        </h6>
                                                        {% if user.is_superuser or status.updated_by == user %}
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-primary btn-sm" onclick="editStatus({{ status.id }}, '{{ status.status|escapejs }}', {{ status.priority }})" title="Edit Status">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteStatus({{ status.id }})" title="Delete Status">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    <p class="card-text" id="status-text-{{ status.id }}">{{ status.status }}</p>
                                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                                        <small class="text-muted">
                                                            <i class="fas fa-clock"></i> {{ status.created_at|date:"Y-m-d H:i:s" }}
                                                        </small>
                                                        {% if status.updated_by %}
                                                        <div class="user-info">
                                                            <span class="badge bg-light text-dark">
                                                                <i class="fas fa-user"></i> {{ status.updated_by.get_full_name }}
                                                                {% if status.updated_by.phone and status.updated_by.phone.strip %}
                                                                    <br><small><i class="fas fa-phone"></i> {{ status.updated_by.phone }}</small>
                                                                {% else %}
                                                                    <br><small><i class="fas fa-phone-slash text-muted"></i> No phone</small>
                                                                {% endif %}
                                                            </span>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-primary">Status Update History</h6>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No status updates available for this product yet.
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if product.image %}
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-primary">Product Image</h6>
                    <img src="{{ product.image.url }}" alt="Product Image" class="img-fluid" style="max-width: 400px;">
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Status Modal -->
<div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStatusModalLabel">
                    <i class="fas fa-edit"></i> Edit Status Update
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editStatusForm">
                <div class="modal-body">
                    <input type="hidden" id="editStatusId" name="status_id">
                    
                    <div class="mb-3">
                        <label for="editStatusText" class="form-label">Status Update</label>
                        <textarea class="form-control" id="editStatusText" name="new_status" rows="4" 
                                  placeholder="Enter your status update..." required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editStatusPriority" class="form-label">Priority Level</label>
                        <select class="form-control" id="editStatusPriority" name="priority">
                            <option value="0">Low</option>
                            <option value="1">Normal</option>
                            <option value="2">High</option>
                            <option value="3">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Status
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Status Modal -->
<div class="modal fade" id="deleteStatusModal" tabindex="-1" aria-labelledby="deleteStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteStatusModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning"></i> Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteStatusId" name="status_id">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning!</strong> Are you sure you want to delete this status update?
                </div>
                <p>This action cannot be undone. The status update will be permanently removed from the system.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete Status Update
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusForm = document.getElementById('statusUpdateForm');
    
    if (statusForm) {
        statusForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            
            fetch('{% url "job_orders:update_production_status" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showAlert('success', data.message);
                    
                    // Clear the form
                    this.reset();
                    
                    // Reload the page to show the new status update
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while updating the status.');
            })
            .finally(() => {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
    
    function showAlert(type, message) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create new alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the content
        const content = document.querySelector('.container-fluid');
        if (content) {
            content.insertBefore(alertDiv, content.firstChild);
        }
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Global functions for edit and delete with AJAX modals
    window.editStatus = function(statusId, currentStatus, currentPriority) {
        // Populate the edit modal
        document.getElementById('editStatusId').value = statusId;
        document.getElementById('editStatusText').value = currentStatus;
        document.getElementById('editStatusPriority').value = currentPriority;
        
        // Show the edit modal
        const editModal = new bootstrap.Modal(document.getElementById('editStatusModal'));
        editModal.show();
    };
    
    window.deleteStatus = function(statusId) {
        // Set the status ID for deletion
        document.getElementById('deleteStatusId').value = statusId;
        
        // Show the delete confirmation modal
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteStatusModal'));
        deleteModal.show();
    };
    
    // Handle edit form submission
    document.getElementById('editStatusForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const statusId = document.getElementById('editStatusId').value;
        const newStatus = document.getElementById('editStatusText').value;
        const newPriority = document.getElementById('editStatusPriority').value;
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        
        const formData = new FormData();
        formData.append('new_status', newStatus);
        formData.append('priority', newPriority);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/job-orders/edit-status-history/${statusId}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                
                // Update the status text and priority badge in the timeline
                const statusTextElement = document.getElementById(`status-text-${statusId}`);
                if (statusTextElement) {
                    statusTextElement.textContent = data.new_status;
                }
                
                const priorityBadge = document.getElementById(`priority-badge-${statusId}`);
                if (priorityBadge) {
                    priorityBadge.textContent = `Priority: ${data.new_priority_display}`;
                    // Update the badge class for color coding
                    priorityBadge.className = `badge ms-2 priority-badge priority-${data.new_priority}`;
                }
                
                // Check if this is the most recent status and update the current production status section
                const statusElements = document.querySelectorAll('.timeline-item');
                if (statusElements.length > 0) {
                    const firstStatusElement = statusElements[0];
                    const firstStatusId = firstStatusElement.id.replace('status-', '');
                    
                    if (firstStatusId == statusId) {
                        // This is the most recent status, update the current production status section
                        const currentStatusText = document.getElementById('current-status-text');
                        if (currentStatusText) {
                            currentStatusText.textContent = data.new_status;
                        }
                        
                        // Update the metadata
                        const currentStatusMeta = document.getElementById('current-status-meta');
                        if (currentStatusMeta) {
                            const now = new Date();
                            const dateString = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                            currentStatusMeta.textContent = `Last updated: ${dateString}`;
                        }
                        
                        // Update the user badge in current status section
                        const currentUserBadge = document.querySelector('#current-production-status .badge');
                        if (currentUserBadge) {
                            let userInfo = '<i class="fas fa-user"></i> {{ user.get_full_name }}';
                            {% if user.phone and user.phone.strip %}
                            userInfo += '<br><small><i class="fas fa-phone"></i> {{ user.phone }}</small>';
                            {% else %}
                            userInfo += '<br><small><i class="fas fa-phone-slash text-muted"></i> No phone</small>';
                            {% endif %}
                            currentUserBadge.innerHTML = userInfo;
                        }
                    }
                }
                
                // Close the modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editStatusModal'));
                editModal.hide();
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'An error occurred while editing the status.');
        })
        .finally(() => {
            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
    
    // Handle delete confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        const statusId = document.getElementById('deleteStatusId').value;
        const submitBtn = this;
        const originalText = submitBtn.innerHTML;
        
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/job-orders/delete-status-history/${statusId}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                // Remove the status element from the page
                const statusElement = document.getElementById(`status-${statusId}`);
                if (statusElement) {
                    statusElement.remove();
                }
                // Close the modal
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteStatusModal'));
                deleteModal.hide();
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'An error occurred while deleting the status.');
        })
        .finally(() => {
            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
});

// Function to update approval status display
function updateApprovalStatus(approvalStatus, approvalStatusDisplay, approvedBy) {
    // Find and update approval status elements
    const statusElements = document.querySelectorAll('[data-approval-status]');
    statusElements.forEach(element => {
        element.textContent = approvalStatusDisplay;
        element.className = `badge bg-${approvalStatus === 'approved' ? 'success' : approvalStatus === 'rejected' ? 'danger' : 'warning'}`;
    });
    
    // Update approved by information if it exists
    const approvedByElements = document.querySelectorAll('[data-approved-by]');
    approvedByElements.forEach(element => {
        element.textContent = approvedBy || 'Not approved';
    });
}

// Listen for storage events (updates from other tabs)
window.addEventListener('storage', function(e) {
    if (e.key === 'product_updated') {
        const updateData = JSON.parse(e.newValue);
        if (updateData.product_id == {{ product.id }}) {
            // Show notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <strong>Product Updated!</strong> The product was updated in another tab.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Update approval status if it changed
            if (updateData.data.approval_status) {
                updateApprovalStatus(
                    updateData.data.approval_status,
                    updateData.data.approval_status_display,
                    updateData.data.approved_by
                );
            }
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
            
            // Optionally refresh the page to show updated data
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    }
});

// Listen for messages from parent windows
window.addEventListener('message', function(e) {
    if (e.data.type === 'product_updated') {
        // Show notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <strong>Product Updated!</strong> The product was updated in another window.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        // Update approval status if it changed
        if (e.data.data.approval_status) {
            updateApprovalStatus(
                e.data.data.approval_status,
                e.data.data.approval_status_display,
                e.data.data.approved_by
            );
        }
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
});
</script>
{% endblock %}
